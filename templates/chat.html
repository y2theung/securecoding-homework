<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì±„íŒ…</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    // 5ì´ˆë§ˆë‹¤ ìƒˆ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    setInterval(function () {
      fetch(window.location.href + '/messages')
        .then(res => res.text())
        .then(html => {
          document.getElementById('message-list').innerHTML = html;
          window.scrollTo(0, document.body.scrollHeight); // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ ì´ë™
        });
    }, 5000);

    function markAsRead(el) {
      const msgId = el.getAttribute('data-id');
      fetch(`/message_read/${msgId}`, { method: 'POST' });
    }
  </script>
</head>
<body>
  <div class="container mt-4">
    <h2 class="mb-4">ğŸ’¬ {{ partner_nickname or 'ìƒëŒ€ë°©' }}ë‹˜ê³¼ì˜ ì±„íŒ…</h2>

    <ul class="list-group mb-3" id="message-list">
      {% for msg in messages %}
      <li class="list-group-item {% if msg.sender_id == session_user_id %}text-end bg-light{% else %}bg-white{% endif %}"
          data-id="{{ msg.id }}" onclick="markAsRead(this)">
        <strong>{{ 'ë‚˜' if msg.sender_id == session_user_id else partner_nickname or 'ìƒëŒ€' }}</strong>
        {% if msg.sender_id != session_user_id and not msg.is_read %}
          <span class="badge bg-danger ms-2">ì½ì§€ ì•ŠìŒ</span>
        {% endif %}<br>
        {{ msg.content }}<br>
        <small class="text-muted">{{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
      </li>
      {% endfor %}
    </ul>

    <!-- ë©”ì‹œì§€ ì „ì†¡ -->
    <form method="post">
      <div class="mb-3">
        <textarea class="form-control" name="content" rows="3" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">ë³´ë‚´ê¸°</button>
    </form>

    <!-- ì†¡ê¸ˆ í¼ -->
    <form method="post" action="/transfer_in_chat" class="mt-4">
        <input type="hidden" name="receiver_id" value="{{ partner_id }}">
        <div class="mb-3">
            <label for="amount" class="form-label">ğŸ’° ì´ ì‚¬ìš©ìì—ê²Œ ì†¡ê¸ˆí•˜ê¸°</label>
            <input type="number" step="1" min="1" name="amount" class="form-control" placeholder="ì˜ˆ: 5000ì›" required>
        </div>
     <button type="submit" class="btn btn-outline-success btn-sm">ì†¡ê¸ˆ</button>
    </form>
  </div>
</body>
</html>
